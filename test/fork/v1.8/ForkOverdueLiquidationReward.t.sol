// SPDX-License-Identifier: MIT
pragma solidity 0.8.23;

import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import {ProposeSafeTxUpgradeToV1_8_3Script} from "@script/ProposeSafeTxUpgradeToV1_8_3.s.sol";
import {DataView} from "@src/market/SizeViewData.sol";
import {ISize} from "@src/market/interfaces/ISize.sol";
import {ISizeView} from "@src/market/interfaces/ISizeView.sol";
import {InitializeFeeConfigParams} from "@src/market/libraries/actions/Initialize.sol";
import {LiquidateParams} from "@src/market/libraries/actions/Liquidate.sol";
import {UpdateConfigParams} from "@src/market/libraries/actions/UpdateConfig.sol";
import {ForkTest} from "@test/fork/ForkTest.sol";
import {SizeMock} from "@test/mocks/SizeMock.sol";

contract ForkOverdueLiquidationRewardTest is ForkTest {
    address private constant TX_SENDER = 0xDe5C38699a7057a33524F96e62Bb1987C2568816;
    uint256 private constant TX_BLOCK = 40_450_767;
    uint256 private constant TX_TIMESTAMP = 1_767_690_881;
    uint256 private constant DEBT_POSITION_ID = 1108;
    address private constant TX_TO = 0x12127D545B90fa47C19C47E5A223B42F88C0Eece;
    bytes private constant TX_DATA =
        hex"322deff80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000c2a429681cad7c1ce36442fbf7a4a68b11eff9400000000000000000000000000000000000000000000000000000000000000454000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000695cd4d80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000de5c38699a7057a33524f96e62bb1987c25688160000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000dc000000000000000000000000000000000000000000000000000000000000000200000000000000000000000004200000000000000000000000000000000000006000000000000000000000000888888888889758f76e7103c6cbf23abbf58f94600000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000d04a373cf1a000000000000000000000000d4f480965d2347d421f1bec7f545682e5ec2151d00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000cc0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000004200000000000000000000000000000000000006000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000001dd5aa9b000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b5000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ae4e21fd0e9000000000000000000000000000000000000000000000000000000000000002000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000005e0000000000000000000000000000000000000000000000000000000000000082000000000000000000000000000000000000000000000000000000000000005200000000000000000022c71014bef3d400000000000000000022c71014bef3d40000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000041d7ffb7284ac55239f2a1adc3195251c9c768e2c6342ec8aa277be37ba0defc0f01362c2737dbf59b4c5dfe12bc176a22e35395abd57a60f895bc455c223e59e71c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000420000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001a0000000000000000002109e8e082347000000000000000000024843748fbb33800000000000000000022c71014bef3d400000000000000000000000001e22d08800000000000000000000000000000000000000000001f90000000f42400000000000000000000000000000004f82e73edb06d29ff62c91ec8f5ff06571bdeb290000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007fffffff0000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000261f598cd00000000000000002b8574f0f6ded2a4846d27350a909c355497d929081c27ac00000000000000002b8574f0f6ded2a4846d27350a909c355497d9290000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000042000000000000000000000000000000000000068000000000000000000000247789ba1a0000000000000000022c71014bef3d40000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000022c71014bef3d40b8d469f800000000000100014f4e4c1c6fa7ce6188807225e5ff4a83b8c50509000000000000000000000000000000000000000000000000000000000000008000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000b0ebf70b3407c0e8c8fd74290e51de7ec77328dd000000000000000000000000ba1333333333a1ba1108e8412f11850a5c319ba9000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291380000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004200000000000000000000000000000000000006000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000000022c71014bef3d40000000000000000000000000000000000000000000000000000000001dd5aa9b00000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000000100000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000022c71014bef3d4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002797b22536f75726365223a2250656e646c65222c22416d6f756e74496e555344223a223530342e343932383632353137393031222c22416d6f756e744f7574555344223a223530342e38323334393639323237393135222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a22353035353938303838222c2254696d657374616d70223a313736373639303838302c22526f7574654944223a2233623536306234332d353139392d343333362d383936662d6631646637363262666466653a34383232626432632d303431302d346138612d393432312d623134363534333864616561222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a224543724f616d6b6b784b4a622f57516161486646686b514f7777726d78637131733141304a574f58756c4d734f616b4b313068445443396f516b4839703653752b58507a51416232786a53416f6276344a37504d375766384b585453567166786b7157356773524a6b6f494b675776567555326c534150757430785166614f67325a726f56485933574265775574623256365a39326a4f53686f3769626478316a5477462b34353967636d3676496c766c6e49317070427043594e3769694a504c50654e6c7672396e566332735950385a6237627465387035585476354574524d4a4f6e6e7a534633617667713461333459445a7142344b5874456645764b502f5138485430766b725749747533305341734e3045776e6a5462304c447046674457783764506e724a34484d73734b36386b7930385636396e713171615468566b627564486b692f3773616a6a6d3039546558536a673d3d227d7d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000022c71014bef3d4000000000000000000000000000000000000000000000000000000000";

    struct Outcome {
        address borrower;
        address liquidator;
        int256 borrowerDelta;
        int256 liquidatorDelta;
        int256 protocolDelta;
    }

    IERC20 private collateralTokenLocal;
    IERC20 private borrowTokenVaultLocal;

    function setUp() public override(ForkTest) {
        vm.createSelectFork("base_archive", TX_BLOCK);
        vm.chainId(8453);
        ISize isize;
        (isize, priceFeed, owner) = importDeployments("base-production-weth-usdc");
        size = SizeMock(address(isize));
        DataView memory dataView = ISizeView(address(isize)).data();
        collateralTokenLocal = IERC20(address(dataView.collateralToken));
        borrowTokenVaultLocal = IERC20(address(dataView.borrowTokenVault));
        if (size.getDebtPosition(DEBT_POSITION_ID).futureValue == 0) {
            vm.rollFork(TX_BLOCK - 1);
            (isize, priceFeed, owner) = importDeployments("base-production-weth-usdc");
            size = SizeMock(address(isize));
            dataView = ISizeView(address(isize)).data();
            collateralTokenLocal = IERC20(address(dataView.collateralToken));
            borrowTokenVaultLocal = IERC20(address(dataView.borrowTokenVault));
        }
    }

    function testFork_overdueLiquidationRewardPercentImpact() public {
        Outcome memory current = _replayAndMeasure(false);
        Outcome memory upgraded = _replayAndMeasure(true);

        assertEq(current.borrower, upgraded.borrower, "borrower");
        assertEq(current.liquidator, upgraded.liquidator, "liquidator");
        assertLe(upgraded.liquidatorDelta, current.liquidatorDelta, "liquidatorDelta");
        assertGe(upgraded.borrowerDelta, current.borrowerDelta, "borrowerDelta");
        // assertGe(upgraded.protocolDelta, current.protocolDelta, "protocolDelta");
    }

    function _replayAndMeasure(bool doUpgrade) internal returns (Outcome memory outcome) {
        uint256 snapshot = vm.snapshot();
        if (doUpgrade) {
            _upgradeToV1_8_3();
        }

        (
            address borrower,
            address liquidator,
            address feeRecipient,
            uint256 borrowerPost,
            uint256 liquidatorPost,
            uint256 protocolPost
        ) = _executeAndCapture();

        vm.revertTo(snapshot);
        if (doUpgrade) {
            _upgradeToV1_8_3();
        }

        uint256 borrowerPre = collateralTokenLocal.balanceOf(borrower);
        uint256 liquidatorPre = collateralTokenLocal.balanceOf(liquidator);
        uint256 protocolPre = collateralTokenLocal.balanceOf(feeRecipient);

        outcome.borrower = borrower;
        outcome.liquidator = liquidator;
        outcome.borrowerDelta = int256(borrowerPost) - int256(borrowerPre);
        outcome.liquidatorDelta = int256(liquidatorPost) - int256(liquidatorPre);
        outcome.protocolDelta = int256(protocolPost) - int256(protocolPre);
    }

    function _executeAndCapture()
        internal
        returns (
            address borrower,
            address liquidator,
            address feeRecipient,
            uint256 borrowerPost,
            uint256 liquidatorPost,
            uint256 protocolPost
        )
    {
        vm.warp(TX_TIMESTAMP);
        liquidator = TX_SENDER;
        borrower = size.getDebtPosition(DEBT_POSITION_ID).borrower;
        feeRecipient = ISizeView(address(size)).feeConfig().feeRecipient;

        vm.prank(liquidator);
        (bool success,) = TX_TO.call(TX_DATA);
        if (!success) {
            // The swap route reverts on fork; fall back to direct liquidation for delta checks.
            _liquidateDirect(liquidator);
        }

        borrowerPost = collateralTokenLocal.balanceOf(borrower);
        liquidatorPost = collateralTokenLocal.balanceOf(liquidator);
        protocolPost = collateralTokenLocal.balanceOf(feeRecipient);
    }

    function _liquidateDirect(address liquidator) internal {
        uint256 futureValue = size.getDebtPosition(DEBT_POSITION_ID).futureValue;
        assertGe(borrowTokenVaultLocal.balanceOf(liquidator), futureValue);
        vm.startPrank(liquidator);
        size.liquidate(
            LiquidateParams({debtPositionId: DEBT_POSITION_ID, minimumCollateralProfit: 0, deadline: type(uint256).max})
        );
        vm.stopPrank();
    }

    function _upgradeToV1_8_3() internal {
        ProposeSafeTxUpgradeToV1_8_3Script script = new ProposeSafeTxUpgradeToV1_8_3Script();
        (address[] memory targets, bytes[] memory datas) = script.getUpgradeToV1_8_3Data();
        for (uint256 i = 0; i < targets.length; i++) {
            vm.prank(owner);
            (bool ok,) = targets[i].call(datas[i]);
            assertTrue(ok);
        }
    }
}
